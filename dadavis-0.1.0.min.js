var dadavis={version:"0.1.0"};if(dadavis.init=function(t){function e(t,e){var a=this;e.internalEvents.on("resize",function(){a.resize()})}function a(t,e){this.setConfig({width:e.container.node().offsetWidth,height:e.container.node().offsetHeight})}function n(t,e,a){a?(e.previousData=a,e.data=a):e.data=e.previousData,e.chartWidth=t.width-t.margin.left-t.margin.right,e.chartHeight=t.height-t.margin.top-t.margin.bottom,"line"===t.type&&(e.noPadding=!0)}var i={containerSelector:".container",width:500,height:500,margin:{top:20,right:20,bottom:50,left:50},type:"bar",subtype:"stacked",labelFormatterX:null,axisXAngle:null,tickSize:10,minorTickSize:3,tickYCount:5,axisXTickSkip:"auto",dotSize:2,gutterPercent:10,colors:["skyblue","orange","lime","orangered","violet","yellow","brown","pink"],renderer:"svg"},r={chartWidth:500,chartHeight:500,data:null,layout:null,scaleX:null,scaleY:null,previousData:null,container:null,noPadding:!1,events:d3.dispatch("hover","hoverOut"),internalEvents:d3.dispatch("setHover","hideHover","resize")};return function(e,a){dadavis.utils.override(t,e),a.container=d3.select(e.containerSelector),a.container.html(dadavis.template.main),d3.select(window).on("resize.namespace"+~~(1e3*Math.random()),dadavis.utils.throttle(function(){a.internalEvents.resize()},200))}(i,r),exports={},exports.setConfig=function(t){return dadavis.utils.override(t,i),this},exports.resize=function(){return r.container.html(dadavis.template.main),this.render(),this},exports.downloadAsPNG=function(t){return dadavis.utils.convertToImage(i,r,t),this},exports.setHovering=function(t){return r.internalEvents.setHover(t),this},exports.hideHovering=function(){return r.internalEvents.hideHover(),this},exports.render=function(t){return e.call(this,i,r),a.call(this,i,r),n.call(this,i,r,t),r.scaleX=dadavis.scale.x(i,r),r.scaleY=dadavis.scale.y(i,r),r.layout=dadavis.layout.data(i,r),r.axesLayout=dadavis.layout.axes(i,r),dadavis.component.chart(i,r),dadavis.component.axisX(i,r),dadavis.component.axisY(i,r),dadavis.interaction.hovering(i,r),this},d3.rebind(exports,r.events,"on"),exports},dadavis.utils={},dadavis.utils.override=function(t,e){for(var a in t)a in e&&(e[a]=t[a])},dadavis.utils.computeRandomNumericArray=function(t,e,a){return d3.range(t||0).map(function(){return~~(Math.random()*(a-e)+e)})},dadavis.utils.computeRandomTimeArray=function(t,e){var a=864e5,e=(new Date).getTime()-t*a;return d3.range(t||0).map(function(t,n){return e+n*a})},dadavis.utils.getRandomNumericData=function(t,e){return d3.range(e).map(function(e,a){return{name:"name"+a,values:dadavis.utils.computeRandomNumericArray(t,10,100)}})},dadavis.utils.getRandomTimeData=function(t,e){var a=(new Date).getTime();return d3.range(e).map(function(e,n){return{name:"name"+n,values:dadavis.utils.computeRandomNumericArray(t,10,100),keys:dadavis.utils.computeRandomTimeArray(t,a)}})},dadavis.utils.throttle=function(t,e){var a=!1,n=null;return function(){a||(t.apply(this,arguments),a=!0,clearTimeout(n),n=setTimeout(function(){a=!1,t.apply(this,arguments)},e))}},dadavis.utils.convertToImage=function(t,e,a){var n=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}),i=e.container.node(),r=(new XMLSerializer).serializeToString(i),o={width:i.offsetWidth,height:i.offsetHeight,rootFontSize:14},d='<svg xmlns="http://www.w3.org/2000/svg" width="'+o.width+'" height="'+o.height+'" font-size="'+o.rootFontSize+'"><foreignObject>'+r+"</foreignObject></svg>",s=document.createElement("canvas");s.width=o.width,s.height=o.height;var c=s.getContext("2d"),l=new Image;l.onload=function(){c.drawImage(l,0,0);var t=s.toDataURL("image/png");if(a)a.call(this,t);else{var e='<a href="'+t+'" download="converted-image">Download</a>',i=document.createElement("div");i.id="#png-container",i.innerHTML=e,i.querySelector("a").dispatchEvent(n)}},l.src="data:image/svg+xml;base64,"+btoa(d)},dadavis.template={},dadavis.template.main='<div class="chart"><div class="panel"><div class="shape"></div><div class="hovering"></div></div><div class="axis-x"></div><div class="axis-y"></div></div>',dadavis.layout={data:{},axes:{}},dadavis.layout.data=function(t,e){var a=e.scaleY.copy(),n=e.scaleY.copy(),i=e.scaleX.copy();return e.data.map(function(t,r){var o=t.values;i.domain([0,o.length]),e.scaleX.domain([0,o.length-1]),e.scaleY.domain([0,d3.max(o)]);var d=d3.transpose(e.data.map(function(t){return t.values})),s=null;return o.map(function(o,c){a.domain([0,d3.sum(d[c])]),n.domain([0,d3.max(d.map(function(t){return d3.sum(t)}))]);var l={value:o,index:c,parentData:t,paddedX:i(c),x:e.scaleX(c),y:e.chartHeight-e.scaleY(o),stackedPercentY:e.chartHeight-a(d3.sum(d[c].slice(0,r+1))),stackedY:e.chartHeight-n(d3.sum(d[c].slice(0,r+1))),paddedW:i(1),w:e.scaleX(1),h:e.scaleY(o),stackedPercentH:a(o),stackedH:n(o),layerCount:e.data.length,layerIndex:r,key:t.keys?t.keys[r]:r};return l.previous=s||l,s=l,l})})},dadavis.layout.axes=function(t,e){var a=e.scaleY.copy(),n=e.scaleY.copy(),i=e.scaleY.copy(),r=d3.transpose(e.data.map(function(t){return t.values})),o=d3.max(e.data.map(function(t){return d3.max(t.values)}));a.domain([o,0]);var d=d3.max(r.map(function(t){return d3.sum(t)}));i.domain([d,0]);var s=d3.max(r.map(function(t){return d3.sum(t)}));return n.domain([s,0]),d3.range(t.tickYCount).map(function(e,n){var i=n*o/(t.tickYCount-1);return{label:i,stackedLabel:n*d/(t.tickYCount-1),labelY:a(i)}})},dadavis.getAttr={bar:{},line:{},point:{},axis:{}},dadavis.getAttr.bar.simple=function(t,e){return e.layout.map(function(e){return e.map(function(e){var a=e.paddedW/100*t.gutterPercent;return{x:e.paddedX,y:e.y,width:e.paddedW-a,height:e.h}})})},dadavis.getAttr.bar.percent=function(t,e){return e.layout.map(function(e){return e.map(function(e){var a=e.paddedW/100*t.gutterPercent;return{x:e.paddedX,y:e.stackedPercentY,width:e.paddedW-a,height:e.stackedPercentH}})})},dadavis.getAttr.bar.stacked=function(t,e){return e.layout.map(function(e){return e.map(function(e){var a=e.paddedW/100*t.gutterPercent;return{x:e.paddedX,y:e.stackedY,width:e.paddedW-a,height:e.stackedH}})})},dadavis.getAttr.point.stacked=function(t,e){return{cx:function(t){return e.noPadding?t.x:t.paddedX+t.paddedW/2},cy:function(t){return t.stackedY}}},dadavis.getAttr.line.simple=function(t,e){return e.layout.map(function(t){return t.map(function(t){return[t.x,t.y]})})},dadavis.getAttr.line.stacked=function(t,e){return e.layout.map(function(t){return t.map(function(t){return[t.x,t.stackedY]})})},dadavis.getAttr.line.area=function(t,e){return e.layout.map(function(t,a){var n=t.map(function(t){return[t.x,t.stackedY]}),i=null;return i=0===a?t.map(function(t){return[t.x,e.chartHeight]}).reverse():e.layout[a-1].map(function(t){return[t.x,t.stackedY]}).reverse(),n.concat(i)})},dadavis.getAttr.axis.labelX=function(t,e){var a={};return a=t.axisXAngle<0?{left:function(t){return e.noPadding?t.index*t.w-this.offsetWidth+"px":t.index*t.paddedW+t.paddedW/2-this.offsetWidth+"px"},"transform-origin":"100%",transform:"rotate("+t.axisXAngle+"deg)"}:t.axisXAngle>0?{left:function(t){return e.noPadding?t.index*t.w+"px":t.index*t.paddedW+t.paddedW/2+"px"},"transform-origin":"0%",transform:"rotate("+t.axisXAngle+"deg)"}:{left:function(t){return e.noPadding?t.index*t.w-this.offsetWidth/2+"px":t.index*t.paddedW+t.paddedW/2-this.offsetWidth/2+"px"}},a.display=function(a,n){return n%(e.axisXTickSkipAuto||t.axisXTickSkip)?"none":"block"},a.top=t.tickSize+"px",a},dadavis.getAttr.axis.tickX=function(t,e){return{left:function(t){return e.noPadding?t.index*t.w-this.offsetWidth+"px":t.index*t.paddedW+t.paddedW/2-this.offsetWidth+"px"},width:"1px",height:function(a,n){return(n%(e.axisXTickSkipAuto||t.axisXTickSkip)?t.minorTickSize:t.tickSize)+"px"}}},dadavis.getAttr.axis.labelY=function(t){return{position:"absolute",left:function(){var e=this.offsetWidth;return t.margin.left-e-t.tickSize+"px"},top:function(t){var e=this.offsetHeight;return t.labelY-e/2+"px"}}},dadavis.getAttr.axis.tickY=function(t){return{width:t.tickSize+"px",height:"1px",position:"absolute",left:t.margin.left-t.tickSize+"px",top:function(t){return t.labelY+"px"}}},dadavis.interaction={},dadavis.interaction.hovering=function(t,e){var a=e.container.select(".hovering").style({width:e.chartWidth+"px",height:e.chartHeight+"px",position:"absolute",opacity:0}).on("mousemove",function(){var a=d3.mouse(this),n=e.layout[0].map(function(e){return"bar"===t.type?e.paddedX:e.x}),i="bar"===t.type?e.layout[0][0].paddedW:e.layout[0][0].w/2,o=d3.bisect(n,a[0]-i);r(o),e.events.hover({mouse:a,x:n,idx:o})}).on("mouseenter",function(){a.style({opacity:1})}).on("mouseout",function(){a.style({opacity:0}),e.events.hoverOut()}),n=dadavis.interaction.hoverLine(t,e),i=dadavis.interaction.tooltip(t,e);e.internalEvents.on("setHover",function(t){r(t.idx)}),e.internalEvents.on("hideHover",function(){a.style({opacity:0})});var r=function(t){var r=e.layout[0][t],o=e.layout.map(function(e){return e[t]});a.style({opacity:1}),n(r),i(o)}},dadavis.interaction.tooltip=function(t,e){return function(a){var n=e.container.select(".hovering"),i=n.selectAll(".tooltip").data(a);i.enter().append("div").attr({"class":"tooltip"}).style({position:"absolute","pointer-events":"none"}),i.html(function(t){return t.value}).style({left:function(e){return("bar"===t.type?e.paddedX+e.paddedW/2:e.x)+"px"},top:function(e){var a=e.stackedY;return"simple"===t.subtype?a=e.y:"percent"===t.subtype&&(a=e.stackedPercentY),a+"px"},"background-color":function(e,a){return t.colors[a]}}),i.exit().remove()}},dadavis.interaction.hoverLine=function(t,e){var a=e.container.select(".hovering").append("div").attr({"class":"hover-line"}).style({position:"absolute",width:"1px",height:e.chartHeight+"px",left:t.margin.left+"px","pointer-events":"none"});return function(e){var n="bar"===t.type?e.paddedX+e.paddedW/2:e.x;a.style({left:n+"px"})}},dadavis.component={},dadavis.component.chart=function(t,e){var a=e.container.select(".chart").style({position:"absolute",width:e.chartWidth+"px",height:e.chartHeight+"px"}),n=(a.select(".panel").style({position:"absolute",left:t.margin.left+"px",top:t.margin.top+"px",width:e.chartWidth+"px",height:e.chartHeight+"px"}),a.select(".shape").style({position:"absolute",width:e.chartWidth+"px",height:e.chartHeight+"px"})),i=dadavis.getAttr[t.type][t.subtype](t,e),r=dadavis.renderer[t.renderer](n.node());return console.time("rendering"),i.forEach("line"===t.type?function(e,a){var n=null;n="area"===t.subtype?t.colors[a]:"none",r.polygon({points:e,fill:n,stroke:t.colors[a]})}:function(e,a){e.forEach(function(e){r.rect({rect:e,fill:t.colors[a],stroke:t.colors[a]})})}),console.timeEnd("rendering"),this},dadavis.component.axisX=function(t,e){var a=e.container.select(".axis-x").style({width:e.chartWidth+"px",height:t.margin.bottom+"px",position:"absolute",top:e.chartHeight+t.margin.top+"px",left:t.margin.left+"px","border-top":"1px solid black"}),n=a.selectAll("div.label").data(e.layout[0]);if(n.enter().append("div").classed("label",!0).style({position:"absolute"}),n.html(function(e,a){var n=e.parentData.keys?e.parentData.keys[a]:a;return t.labelFormatterX?t.labelFormatterX(n,a):n}).style(dadavis.getAttr.axis.labelX(t,e)),"auto"===t.axisXTickSkip){var i=d3.max(n[0].map(function(t){return t.offsetWidth}));e.axisXTickSkipAuto=Math.ceil(e.layout[0].length/~~(e.chartWidth/i))}n.style(dadavis.getAttr.axis.labelX(t,e)),n.exit().remove();var r=a.selectAll("div.tick").data(e.layout[0]);r.enter().append("div").classed("tick",!0).style({position:"absolute"}).style({"background-color":"black"}),r.style(dadavis.getAttr.axis.tickX(t,e)),r.exit().remove()},dadavis.component.axisY=function(t,e){var a=e.container.select(".axis-y").style({width:t.margin.left+"px",height:e.chartHeight+"px",position:"absolute",top:t.margin.top+"px",left:"0px","border-right":"1px solid black"}),n=a.selectAll("div.label").data(e.axesLayout);n.enter().append("div").classed("label",!0),n.html(function(e){return"simple"===t.subtype?e.label:e.stackedLabel}).style(dadavis.getAttr.axis.labelY(t,e)),n.exit().remove();var i=a.selectAll("div.tick").data(e.axesLayout);i.enter().append("div").classed("tick",!0).style({"background-color":"black"}),i.style(dadavis.getAttr.axis.tickY(t,e)),i.exit().remove()},"function"==typeof define&&define.amd)define(dadavis);else if("object"==typeof module&&module.exports){var d3=require("d3");module.exports=dadavis}