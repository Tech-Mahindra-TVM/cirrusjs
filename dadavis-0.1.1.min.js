var dadavis={version:"0.1.1"};if(dadavis.init=function(t){function e(t,e){e.container=d3.select(t.containerSelector),e.container.html(dadavis.template.main);var a=this;e.internalEvents.on("resize",function(){a.resize()})}function a(t,e){if("auto"===t.type){var a=e.data[0].values.length;a<t.autoTypeThreshold?(t.type="bar",t.continuousXAxis=!1,t.outerPadding="auto"):(t.type="line",t.continuousXAxis=!0)}if("auto"===t.outerPadding){var i=dadavis.utils.extractValues(e.data,t.keyX);t.outerPadding=e.chartWidth/i[0].length/4}this.setConfig({width:e.container.node().offsetWidth,height:e.container.node().offsetHeight})}function i(t){if(t&&"object"==typeof t){var e=!1;if(t.forEach(function(t){e=e||!!t.values.length}),e)return o.previousData=t,o.data=t,!0}return o.previousData?(o.data=o.previousData,!0):!1}function n(t,e){e.chartWidth=t.width-t.margin.left-t.margin.right,e.chartHeight=t.height-t.margin.top-t.margin.bottom,"line"===t.type&&(e.noPadding=!0)}var r={containerSelector:".container",width:500,height:500,margin:{top:20,right:20,bottom:50,left:50},type:"bar",subtype:"stacked",labelFormatterX:function(t){return t},axisXAngle:null,tickSize:15,minorTickSize:10,fringeSize:8,tickYCount:5,axisXTickSkip:"auto",continuousXAxis:!1,dotSize:2,gutterPercent:10,colors:["skyblue","orange","lime","orangered","violet","yellow","brown","pink"],renderer:"svg",scaleType:"time",keyX:"x",keyY:"y",outerPadding:0,showFringe:!1,showAxes:!0,autoTypeThreshold:30},o={chartWidth:500,chartHeight:500,data:null,layout:null,scaleX:null,scaleY:null,axesLayout:{},previousData:null,container:null,noPadding:!1,events:d3.dispatch("hover","hoverOut"),internalEvents:d3.dispatch("setHover","hideHover","resize")};return function(e,a){dadavis.utils.override(t,e),d3.select(window).on("resize.namespace"+~~(1e3*Math.random()),dadavis.utils.throttle(function(){a.internalEvents.resize()},200))}(r,o),exports={},exports.setConfig=function(t){return dadavis.utils.override(t,r),this},exports.resize=function(){return o.container.html(dadavis.template.main),this.render(),this},exports.downloadAsPNG=function(t){return dadavis.utils.convertToImage(r,o,t),this},exports.setHovering=function(t){return o.internalEvents.setHover(t),this},exports.hideHovering=function(){return o.internalEvents.hideHover(),this},exports.render=function(t){return i(t)?(e.call(this,r,o),a.call(this,r,o),n.call(this,r,o,t),o.scaleX=dadavis.scale.x(r,o),o.scaleY=dadavis.scale.y(r,o),o.layout=dadavis.layout.data(r,o),o.axesLayout.x=dadavis.layout.axes.x(r,o),o.axesLayout.y=dadavis.layout.axes.y(r,o),dadavis.component.chart(r,o),dadavis.component.axisX(r,o),dadavis.component.axisY(r,o),dadavis.interaction.hovering(r,o),this):(console.error("Invalid data",t),this)},d3.rebind(exports,o.events,"on"),exports},dadavis.utils={},dadavis.utils.override=function(t,e){for(var a in t)a in e&&(e[a]=t[a])},dadavis.utils.computeRandomNumericArray=function(t,e,a){return d3.range(t||0).map(function(){return~~(Math.random()*(a-e)+e)})},dadavis.utils.computeRandomTimeArray=function(t,e){var a=864e5,e=(new Date).getTime()-t*a;return d3.range(t||0).map(function(t,i){return e+i*a})},dadavis.utils.getRandomNumericData=function(t,e){var a=d3.range(t);return d3.range(e).map(function(e,i){var n=dadavis.utils.computeRandomNumericArray(t,10,100),r=d3.zip(a,n).map(function(t){return{x:t[0],y:t[1]}});return{name:"name"+i,values:r}})},dadavis.utils.getRandomTimeData=function(t,e){var a=(new Date).getTime(),i=dadavis.utils.computeRandomTimeArray(t,a);return d3.range(e).map(function(e,a){var n=dadavis.utils.computeRandomNumericArray(t,10,100),r=d3.zip(i,n).map(function(t){return{x:t[0],y:t[1]}});return{name:"name"+a,values:r}})},dadavis.utils.throttle=function(t,e){var a=!1,i=null;return function(){a||(t.apply(this,arguments),a=!0,clearTimeout(i),i=setTimeout(function(){a=!1,t.apply(this,arguments)},e))}},dadavis.utils.convertToImage=function(t,e,a){var i=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}),n=e.container.node(),r=(new XMLSerializer).serializeToString(n),o={width:n.offsetWidth,height:n.offsetHeight,rootFontSize:14},s='<svg xmlns="http://www.w3.org/2000/svg" width="'+o.width+'" height="'+o.height+'" font-size="'+o.rootFontSize+'"><foreignObject>'+r+"</foreignObject></svg>",l=document.createElement("canvas");l.width=o.width,l.height=o.height;var d=l.getContext("2d"),u=new Image;u.onload=function(){d.drawImage(u,0,0);var t=l.toDataURL("image/png");if(a)a.call(this,t);else{var e='<a href="'+t+'" download="converted-image">Download</a>',n=document.createElement("div");n.id="#png-container",n.innerHTML=e,n.querySelector("a").dispatchEvent(i)}},u.src="data:image/svg+xml;base64,"+btoa(s)},dadavis.utils.extractValues=function(t,e){return t.map(function(t){return t.values.map(function(t){return t[e]})})},dadavis.template={},dadavis.template.main='<div class="chart"><div class="panel"><div class="shape"></div><div class="hovering"></div></div><div class="axis-x"></div><div class="axis-y"></div></div>',dadavis.layout={data:{},axes:{}},dadavis.layout.data=function(t,e){var a=e.scaleY.copy(),i=e.scaleY.copy(),n=dadavis.utils.extractValues(e.data,t.keyY),r=d3.transpose(n),o=null,s=Number.MAX_VALUE;return e.data[0].values.forEach(function(a,i){var n=a[t.keyX];"time"===t.scaleType?n=new Date(n):"ordinal"===t.scaleType&&(n=i);var r=e.scaleX(n)-e.scaleX(o);0!==i&&s>r&&(s=r),o=n}),s=Math.max(s,1),e.data.map(function(n,o){var l=null;return n.values.map(function(d,u){a.domain([0,d3.sum(r[u])]),i.domain([0,d3.max(r.map(function(t){return d3.sum(t)}))]);var c=d[t.keyX];"time"===t.scaleType?c=new Date(c):"ordinal"===t.scaleType&&(c=u);var p=d[t.keyY],v=s/100*t.gutterPercent,f={key:d[t.keyX],value:p,normalizedValue:p/e.scaleY.domain()[1],index:u,parentData:n,x:e.scaleX(c),y:e.chartHeight-e.scaleY(p),stackedPercentY:e.chartHeight-a(d3.sum(r[u].slice(0,o+1))),stackedY:e.chartHeight-i(d3.sum(r[u].slice(0,o+1))),w:s,h:e.scaleY(p),gutterW:v,stackedPercentH:a(p),stackedH:i(p),layerCount:e.data.length,layerIndex:o,centerX:e.scaleX(c)+s/2};return f.previous=l||f,l=f,f})})},dadavis.layout.axes.x=function(t,e){var a=e.scaleX.copy();return t.continuousXAxis?a.ticks().map(function(t){return{key:t,x:a(t)}}):e.data[0].values.map(function(e,i){var n=e[t.keyX];return"time"===t.scaleType?n=new Date(n):"ordinal"===t.scaleType&&(n=i),{key:e[t.keyX],x:a(n)}})},dadavis.layout.axes.y=function(t,e){var a=e.scaleY.copy(),i=e.scaleY.copy(),n=e.scaleY.copy(),r=dadavis.utils.extractValues(e.data,t.keyY),o=d3.transpose(r),s=d3.max(d3.merge(r));a.domain([s,0]);var l=d3.max(o.map(function(t){return d3.sum(t)}));n.domain([l,0]);var d=d3.max(o.map(function(t){return d3.sum(t)}));return i.domain([d,0]),d3.range(t.tickYCount).map(function(e,i){var n=i*s/(t.tickYCount-1);return{label:n,stackedLabel:i*l/(t.tickYCount-1),labelY:a(n)}})},dadavis.attribute={bar:{},line:{},point:{},axis:{}},dadavis.attribute.bar.simple=function(t,e){return e.layout.map(function(t){return t.map(function(t){return{x:t.x-t.w/2+t.gutterW/2,y:t.y,width:t.w-t.gutterW,height:t.h}})})},dadavis.attribute.bar.percent=function(t,e){return e.layout.map(function(t){return t.map(function(t){return{x:t.x-t.w/2+t.gutterW/2,y:t.stackedPercentY,width:t.w-t.gutterW,height:t.stackedPercentH}})})},dadavis.attribute.bar.stacked=function(t,e){return e.layout.map(function(t){return t.map(function(t){return{x:t.x-t.w/2+t.gutterW/2,y:t.stackedY,width:t.w-t.gutterW,height:t.stackedH}})})},dadavis.attribute.point.stacked=function(t,e){return{cx:function(t){return e.noPadding?t.x:t.centerX},cy:function(t){return t.stackedY}}},dadavis.attribute.line.simple=function(t,e){return e.layout.map(function(t){return t.map(function(t){return[t.x,t.y]})})},dadavis.attribute.line.stacked=function(t,e){return e.layout.map(function(t){return t.map(function(t){return[t.x,t.stackedY]})})},dadavis.attribute.line.area=function(t,e){return e.layout.map(function(t,a){var i=t.map(function(t){return[t.x,t.stackedY]}),n=null;return n=0===a?t.map(function(t){return[t.x,e.chartHeight]}).reverse():e.layout[a-1].map(function(t){return[t.x,t.stackedY]}).reverse(),i.concat(n)})},dadavis.attribute.axis.labelX=function(t){var e={};return e=t.axisXAngle<0?{left:function(t){return t.x-this.offsetWidth+"px"},"transform-origin":"100%",transform:"rotate("+t.axisXAngle+"deg)"}:t.axisXAngle>0?{left:function(t){return t.x+"px"},"transform-origin":"0%",transform:"rotate("+t.axisXAngle+"deg)"}:{left:function(t){return t.x-this.offsetWidth/2+"px"}},e.display=function(e,a){return a%t.axisXTickSkip?"none":"block"},e.top=t.tickSize+"px",e},dadavis.attribute.axis.tickX=function(t){var e=1;return{left:function(t){return t.x-e/2-this.offsetWidth+"px"},width:e+"px",height:function(e,a){return(a%t.axisXTickSkip?t.minorTickSize:t.tickSize)+"px"}}},dadavis.attribute.axis.fringeX=function(t){var e=d3.scale.linear().domain([0,1]).range(["yellow","limegreen"]);return{left:function(t){return t.x-t.w/2+t.gutterW/2-this.offsetWidth+"px"},width:function(t){return Math.max(t.w-t.gutterW,1)+"px"},height:function(){return t.fringeSize+"px"},"background-color":function(t){return e(t.normalizedValue)}}},dadavis.attribute.axis.labelY=function(t){return{position:"absolute",left:function(){var e=this.offsetWidth;return t.margin.left-e-t.tickSize+"px"},top:function(t){var e=this.offsetHeight;return t.labelY-e/2+"px"}}},dadavis.attribute.axis.tickY=function(t){return{width:t.tickSize+"px",height:"1px",position:"absolute",left:t.margin.left-t.tickSize+"px",top:function(t){return t.labelY+"px"}}},dadavis.attribute.axis.fringeY=function(t){var e=d3.scale.linear().domain([0,1]).range(["yellow","limegreen"]),a=3;return{position:"absolute",left:t.margin.left-t.fringeSize+"px",top:function(t){return t.y-a/2+"px"},width:function(){return t.fringeSize+"px"},height:function(){return a+"px"},"background-color":function(t){return e(t.normalizedValue)}}},dadavis.interaction={},dadavis.interaction.hovering=function(t,e){var a=e.container.select(".hovering").style({width:e.chartWidth+"px",height:e.chartHeight+"px",position:"absolute",opacity:0}).on("mousemove",function(){var t=d3.mouse(this),a=e.layout[0].map(function(t){return t.x}),i=e.layout[0][0].w/2,n=d3.bisect(a,t[0]-i);n=Math.min(n,a.length-1),r(n),e.events.hover({mouse:t,x:a,idx:n})}).on("mouseenter",function(){a.style({opacity:1})}).on("mouseout",function(){a.style({opacity:0}),e.events.hoverOut()}),i=dadavis.interaction.hoverLine(t,e),n=dadavis.interaction.tooltip(t,e);e.internalEvents.on("setHover",function(t){r(t.idx)}),e.internalEvents.on("hideHover",function(){a.style({opacity:0})});var r=function(t){var r=e.layout[0][t],o=e.layout.map(function(e){return e[t]});a.style({opacity:1}),i(r),n(o)}},dadavis.interaction.tooltip=function(t,e){return function(a){var i=e.container.select(".hovering"),n=i.selectAll(".tooltip").data(a);n.enter().append("div").attr({"class":"tooltip"}).style({position:"absolute","pointer-events":"none"}),n.html(function(t){return t.value}).style({left:function(t){return t.x+"px"},top:function(e){var a=e.stackedY;return"simple"===t.subtype?a=e.y:"percent"===t.subtype&&(a=e.stackedPercentY),a+"px"},"background-color":function(e,a){return t.colors[a]}}),n.exit().remove()}},dadavis.interaction.hoverLine=function(t,e){var a=e.container.select(".hovering").append("div").attr({"class":"hover-line"}).style({position:"absolute",width:"1px",height:e.chartHeight+"px",left:t.margin.left+"px","pointer-events":"none"});return function(t){a.style({left:t.x+"px"})}},dadavis.scale={},dadavis.scale.x=function(t,e){var a=dadavis.utils.extractValues(e.data,t.keyX),i=d3.merge(a),n=[t.outerPadding,e.chartWidth-t.outerPadding],r=null;return"time"===t.scaleType?(r=d3.time.scale().range(n),i=i.map(function(t){return new Date(t)}),r.domain(d3.extent(i))):"ordinal"===t.scaleType?(r=d3.scale.linear().range(n),r.domain([0,a[0].length-1])):(r=d3.scale.linear().range(n),r.domain(d3.extent(i))),r},dadavis.scale.y=function(t,e){var a=d3.merge(dadavis.utils.extractValues(e.data,t.keyY));return d3.scale.linear().range([0,e.chartHeight]).domain([0,d3.max(a)])},dadavis.renderer={svg:null,canvas:null},dadavis.renderer.svg=function(t){var e={},a=d3.select(t).append("svg").attr({width:t.offsetWidth,height:t.offsetHeight}).style({position:"absolute"});return e.polygon=function(t){return a.append("path").attr({d:"M"+t.points.join("L"),fill:t.fill||"silver",stroke:t.stroke||"silver"}),this},e.rect=function(t){return path=a.append("rect").attr(t.rect).attr({fill:t.fill||"silver",stroke:t.stroke||"silver"}),this},e},dadavis.renderer.canvas=function(t){var e={},a=d3.select(t).append("canvas").attr({width:t.offsetWidth,height:t.offsetHeight}).style({position:"absolute"}),i=a.node().getContext("2d");return e.polygon=function(t){var e=t.fill;return"none"!==t.fill&&t.fill||(e="transparent"),i.fillStyle=e,i.strokeStyle=t.stroke,i.beginPath(),t.points.forEach(function(t,e){0===e?i.moveTo(t[0],t[1]):i.lineTo(t[0],t[1])}),i.fill(),i.stroke(),this},e.rect=function(t){return i.fillStyle=t.fill,i.strokeStyle=t.stroke,i.fillRect(t.rect.x,t.rect.y,t.rect.width,t.rect.height),this},e.circle=function(t){return i.fillStyle=t.fill,i.strokeStyle=t.stroke,context.beginPath(),context.arc(t.circle.x,t.circle.y,t.circle.r,0,2*Math.PI,!1),context.fill(),context.stroke(),this},e},dadavis.component={},dadavis.component.chart=function(t,e){var a=e.container.select(".chart").style({position:"absolute",width:e.chartWidth+"px",height:e.chartHeight+"px"}),i=(a.select(".panel").style({position:"absolute",left:t.margin.left+"px",top:t.margin.top+"px",width:e.chartWidth+"px",height:e.chartHeight+"px"}),a.select(".shape").style({position:"absolute",width:e.chartWidth+"px",height:e.chartHeight+"px"})),n=dadavis.attribute[t.type][t.subtype](t,e),r=dadavis.renderer[t.renderer](i.node());return n.forEach("line"===t.type?function(e,a){var i=null;i="area"===t.subtype?t.colors[a]:"none",r.polygon({points:e,fill:i,stroke:t.colors[a]})}:function(e,a){e.forEach(function(e){r.rect({rect:e,fill:t.colors[a],stroke:t.colors[a]})})}),this},dadavis.component.axisX=function(t,e){if(t.showAxes){var a=e.container.select(".axis-x").style({width:e.chartWidth+"px",height:t.margin.bottom+"px",position:"absolute",top:e.chartHeight+t.margin.top+"px",left:t.margin.left+"px","border-top":"1px solid black"}),i=a.selectAll("div.label").data(e.axesLayout.x);if(i.enter().append("div").classed("label",!0).style({position:"absolute"}),i.html(function(e,a){return t.labelFormatterX(e.key,a)}).style(dadavis.attribute.axis.labelX(t,e)),"auto"===t.axisXTickSkip){var n=null;i[0].forEach(function(t){var e=!1;return n&&(e=parseFloat(t.style.left)-parseFloat(n.style.left)<t.offsetWidth),e||(n=t),d3.select(t).style({opacity:+!e}),t.offsetWidth})}i.style(dadavis.attribute.axis.labelX(t,e)),i.exit().remove();var r=a.selectAll("div.tick").data(e.axesLayout.x);if(r.enter().append("div").classed("tick",!0).style({position:"absolute"}).style({"background-color":"black"}),r.style(dadavis.attribute.axis.tickX(t,e)),r.exit().remove(),t.showFringe){var o=a.selectAll("div.fringe-x").data(e.layout[0]);o.enter().append("div").classed("fringe-x",!0).style({position:"absolute"}),o.style(dadavis.attribute.axis.fringeX(t,e)),o.exit().remove()}}},dadavis.component.axisY=function(t,e){if(t.showAxes){var a=e.container.select(".axis-y").style({width:t.margin.left+"px",height:e.chartHeight+"px",position:"absolute",top:t.margin.top+"px",left:"0px","border-right":"1px solid black"}),i=a.selectAll("div.label").data(e.axesLayout.y);i.enter().append("div").classed("label",!0),i.html(function(e){return"simple"===t.subtype?e.label:e.stackedLabel}).style(dadavis.attribute.axis.labelY(t,e)),i.exit().remove();var n=a.selectAll("div.tick").data(e.axesLayout.y);if(n.enter().append("div").classed("tick",!0).style({"background-color":"black"}),n.style(dadavis.attribute.axis.tickY(t,e)),n.exit().remove(),t.showFringe){var r=a.selectAll("div.fringe-y").data(e.layout[0]);r.enter().append("div").classed("fringe-y",!0).style({position:"absolute"}),r.style(dadavis.attribute.axis.fringeY(t,e)),r.exit().remove()}}},"function"==typeof define&&define.amd)define(dadavis);else if("object"==typeof module&&module.exports){var d3=require("d3");module.exports=dadavis}